<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>NYC Climate Resilience Story</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
    <script src="https://unpkg.com/scrollama"></script>
    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; overflow: hidden; }
        #map { position: fixed; top: 0; bottom: 0; width: 100%; }
        #story {
            position: absolute; top: 0; left: 0;
            width: 33vw; max-width: 400px; height: 100vh;
            padding: 20px; overflow-y: auto; background: rgba(255,255,255,0.9);
            z-index: 10;
        }
        .step { margin-bottom: 50vh; opacity: 0.25; }
        .step.active { opacity: 0.9; }
        .step img { width: 100%; margin-bottom: 10px; }
    </style>
</head>
<body>
<div id="map"></div>
<div id="story"></div>

<script src="./config.js"></script>
<script>
mapboxgl.accessToken = config.accessToken;

var map = new mapboxgl.Map({
    container: 'map',
    style: config.style,
    center: config.chapters[0].location.center,
    zoom: config.chapters[0].location.zoom,
    pitch: config.chapters[0].location.pitch,
    bearing: config.chapters[0].location.bearing,
    interactive: false
});

map.on('load', function() {
    var scroller = scrollama();

    scroller.setup({ step: '.step', offset: 0.5 })
    .onStepEnter(response => {
        var chapter = config.chapters.find(chap => chap.id === response.element.id);
        response.element.classList.add('active');
        map.flyTo(chapter.location);
        chapter.onChapterEnter.forEach(layer => {
            map.setPaintProperty(layer.layer, 'fill-opacity', layer.opacity);
        });
    })
    .onStepExit(response => {
        response.element.classList.remove('active');
        var chapter = config.chapters.find(chap => chap.id === response.element.id);
        chapter.onChapterExit.forEach(layer => {
            map.setPaintProperty(layer.layer, 'fill-opacity', layer.opacity);
        });
    });

    // 콘텐츠 자동 생성
    var story = document.getElementById('story');
    config.chapters.forEach(chap => {
        var step = document.createElement('div');
        step.setAttribute('id', chap.id);
        step.classList.add('step');
        step.innerHTML = `<h3>${chap.title}</h3><img src="${chap.image}"><p>${chap.description}</p>`;
        story.appendChild(step);
    });
});
</script>
</body>
</html>


