<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>NYC Climate Resilience Story</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v2.0.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v2.0.0/mapbox-gl.css' rel='stylesheet' />
    <script src="https://unpkg.com/scrollama"></script>
    <style>
        body { margin:0; padding:0; font-family: sans-serif; }
        #map { position:fixed; top:0; bottom:0; width:100%; }
        #story { position:absolute; top:0; left:0; padding:20px; width:33%; height:100%; overflow-y:scroll; }
        .step { margin-bottom:40vh; opacity:0.2; }
        .step.active { opacity:1; }
        .step img { width:100%; }
    </style>
</head>
<body>
<div id="map"></div>
<div id="story"></div>

<script src="./config.js"></script>
<script>
mapboxgl.accessToken = config.accessToken;

var map = new mapboxgl.Map({
    container: 'map',
    style: config.style,
    center: config.chapters[0].location.center,
    zoom: config.chapters[0].location.zoom,
    pitch: config.chapters[0].location.pitch,
    bearing: config.chapters[0].location.bearing,
    interactive: false
});

map.on("load", function() {
    map.addSource('geo-export-7g8024', {
        type: 'geojson',
        data: './data/geo-export-7g8024.geojson'
    });

    map.addLayer({
        id: 'geo-export-7g8024',
        type: 'fill',
        source: 'geo-export-7g8024',
        paint: { 'fill-color': '#FF0000', 'fill-opacity': 0 }
    });

    map.addSource('greenroofdata2016-20180917-4qmirf', {
        type: 'geojson',
        data: './data/greenroofdata2016-20180917-4qmirf.geojson'
    });

    map.addLayer({
        id: 'greenroofdata2016-20180917-4qmirf',
        type: 'fill',
        source: 'greenroofdata2016-20180917-4qmirf',
        paint: { 'fill-color': '#00FF00', 'fill-opacity': 0 }
    });

    var scroller = scrollama();
    scroller.setup({ step: '.step', offset: 0.5 })
    .onStepEnter(response => {
        var chapter = config.chapters.find(chap => chap.id === response.element.id);
        response.element.classList.add('active');
        map.flyTo(chapter.location);
        chapter.onChapterEnter.forEach(layer => {
            map.setPaintProperty(layer.layer, 'fill-opacity', layer.opacity);
        });
    })
    .onStepExit(response => {
        response.element.classList.remove('active');
    });
});

var story = document.getElementById('story');
config.chapters.forEach(chap => {
    var step = document.createElement('div');
    step.setAttribute('id', chap.id);
    step.classList.add('step');
    step.innerHTML = `<h3>${chap.title}</h3><img src="${chap.image}"><p>${chap.description}</p>`;
    story.appendChild(step);
});
</script>
</body>
</html>
